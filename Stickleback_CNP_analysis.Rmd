---
title: "Stickleback CNP"
author: "Rita Grunberg"
date: "4/27/2021"
output: html_document
---

```{r setup,  results='hide', message=FALSE, warning=FALSE}
rm(list = ls())  # clear Rs brain 

library(readr)   # read csv file in - easy
library(tidyr)   # tidying data
library(dplyr)   # manipulating df
library(ggplot2) # graphing
library(ggpubr)  # nice package for figures
library(cowplot) # plot grid

stickstoich <- read_csv("C:/Users/grunberg/Documents/GitHub/SticklebackCNP/Data/Stickleback_CNP.csv")

```

Add graphical theme I use for plotting

```{r formatting}
rita_theme <-  theme_classic(base_size = 15)+
  theme(legend.title = element_text(size=7, face="bold"),
        legend.text = element_text(size=6.5),
        legend.position=c(0.15,0.18),
        axis.line = element_line(colour = 'black', size = 0.75),
        axis.ticks = element_line(colour = "black", size = 0.75),
        axis.text.x = element_text(size=12,  colour = "black"), 
        axis.text.y = element_text(size=12,  colour = "black"), # bold
        axis.title.y = element_text(size=14, colour = "black")
  )

```

Some data cleaning. Looking for data that looks weird and checking some stuff

```{r data cleaning and summary information}

#remove fish not analyzed for CNP
stickstoich <- stickstoich %>% drop_na(percentN_fish) # NA in percent N means fish was not analyzed for CNP

#df now has 52 fish 
stickstoich %>% filter(tapeworm_presence == 'yes') %>% summarise(total_fish = n_distinct(ID))

#note remove host 20.030 for paired stoichiometry analysis (parasite too small to analyze, parasite ~ 0.1 mg wet mass, also had no CNP values )
stickstoich %>% filter(tapeworm_presence == 'yes') %>% filter(percentN_worm > 0)%>%
  summarise(total_fish = n_distinct(ID))

#sample size for uninfected fish 
stickstoich %>% filter(tapeworm_presence == 'no') %>% summarise(total_fish = n_distinct(ID))

# Look at data to look for suspicious points
plot(wet_weight_fish_mg ~ standard_length_mm, stickstoich)
hist(stickstoich$dry_weight_worm_mg, col = "grey70")
plot(dry_weight_worm_mg ~ wet_weight_worm_mg, data = stickstoich) #dry mass of worm is clearly off for one observation 
```

First paired t-test to asses whether stickleback and S. solidus elemental composition differ for infected individuals only

```{r host parasite stoichiometry t-test}
stick_infected <- stickstoich %>% filter(tapeworm_presence == 'yes')  %>% filter(!ID ==20.030) #fish lacks paired CNP parasite data 

t.test(stick_infected$percentC_worm,stick_infected$percentC_fish, paired=TRUE)
t.test(stick_infected$percentN_worm, stick_infected$percentN_fish, paired=TRUE)
t.test(stick_infected$percentP_worm,stick_infected$percentP_fish, paired=TRUE)

stick_meanC <- stickstoich %>% filter(tapeworm_presence == 'yes') %>%
  summarise_at(c('percentC_fish', 'percentC_worm'),
               funs(mean, sd, se=sd(.)/sqrt(n()))
               )%>% mutate(Element = "C")

stick_meanN <- stickstoich %>% filter(tapeworm_presence == 'yes') %>%
  summarise_at(c( 'percentN_fish', 'percentN_worm'),        
               funs(mean, sd, se=sd(.)/sqrt(n()))
               )%>% mutate(Element = "N")

stick_meanP <- stickstoich %>% filter(tapeworm_presence == 'yes') %>%
  summarise_at(c('percentP_fish', 'percentP_worm'), 
               funs(mean, sd, se=sd(.)/sqrt(n()))
               )%>% mutate(Element = "P")
# next look at ratios 
t.test(stick_infected$CNmolar_cestode,stick_infected$CNmolar_fish, paired=TRUE)
t.test(stick_infected$CPmolar_cestode, stick_infected$CPmolar_fish, paired=TRUE)
t.test(stick_infected$NPmolar_cestode,stick_infected$NPmolar_fish, paired=TRUE)


```
```{r host parasite stoichiometry correlation}
cor.test(stick_infected$percentC_worm,stick_infected$percentC_fish)
cor.test(stick_infected$percentN_worm, stick_infected$percentN_fish)
cor.test(stick_infected$percentP_worm,stick_infected$percentP_fish)

cor.test(stick_infected$CNmolar_fish,stick_infected$CNmolar_cestode)
cor.test(stick_infected$CPmolar_fish, stick_infected$CPmolar_cestode)
cor.test(stick_infected$NPmolar_fish,stick_infected$NPmolar_cestode)
```

```{r stick and parasite correlation graphics}
Carbon <-stickstoich%>% ggplot()+
  geom_point(aes(x=percentC_fish, y = percentC_worm), pch=21, size=2)+rita_theme+ labs(x= "%C stickleback", y="%C schistocephalus")+
  xlim(c(20,60))+   ylim(c(20,60)) +
  geom_smooth(aes(x=percentC_fish, y = percentC_worm),method='lm',se=FALSE)+
  geom_abline(intercept = 0, slope = 1, lty=2)

carbon.mod <-lm(percentC_worm~ percentC_fish, data=stickstoich)
summary(carbon.mod)

Nitrogen <-stickstoich%>% ggplot()+
  geom_point(aes(x=percentN_fish, y = percentN_worm), pch=21, size=2)+rita_theme+ labs(x= "%N stickleback", y="%N schistocephalus")+
  xlim(c(5,14))+   ylim(c(5,14)) +
    geom_smooth(aes(x=percentN_fish, y = percentN_worm),method='lm',se=FALSE)+
   geom_abline(intercept = 0, slope = 1, lty=2)

nitrogen.mod <-lm(percentN_worm~ percentN_fish, data=stickstoich)
summary(nitrogen.mod)

Phosphorus <-stickstoich%>% ggplot()+
  geom_point(aes(x=percentP_fish, y = percentP_worm), pch=21, size=2)+rita_theme+ labs(x= "%P stickleback", y="%P schistocephalus")+
   xlim(c(1,7))+   ylim(c(1,7)) +
    geom_smooth(aes(x=percentP_fish, y = percentP_worm),method='lm',se=FALSE)+
   geom_abline(intercept = 0, slope = 1, lty=2)

phosph.mod <-lm(percentP_worm~ percentP_fish, data=stickstoich)
summary(phosph.mod)

CN <-stickstoich%>% ggplot()+
  geom_point(aes(x=CNmolar_fish, y = CNmolar_cestode), pch=21, size=2)+rita_theme+ labs(x= "C:N stickleback", y="C:N schistocephalus")+
  xlim(c(1,3.5))+   ylim(c(1,3.5)) +
    geom_smooth(aes(x=CNmolar_fish, y = CNmolar_cestode),method='lm',se=FALSE)+
   geom_abline(intercept = 0, slope = 1, lty=2)

cn.mod <-lm(CNmolar_cestode~ CNmolar_fish, data=stickstoich)
summary(cn.mod)

CP <-stickstoich%>% ggplot()+
  geom_point(aes(x=CPmolar_fish, y = CPmolar_cestode), pch=21, size=2)+rita_theme+ labs(x= "C:P stickleback", y="C:P schistocephalus")+
  xlim(c(6,40))+   ylim(c(6,40)) +
    geom_smooth(aes(x=CPmolar_fish, y = CPmolar_cestode),method='lm',se=FALSE)+
   geom_abline(intercept = 0, slope = 1, lty=2)

cp.mod <-lm(CPmolar_cestode~ CPmolar_fish, data=stickstoich)
summary(cp.mod)

NP <-stickstoich%>% ggplot()+
  geom_point(aes(x=NPmolar_fish, y = NPmolar_cestode), pch=21, size=2)+rita_theme+ labs(x= "N:P stickleback", y="N:P schistocephalus")+
   xlim(c(2,25))+   ylim(c(2,25)) +
    geom_smooth(aes(x=NPmolar_fish, y = NPmolar_cestode),method='lm',se=FALSE)+
   geom_abline(intercept = 0, slope = 1, lty=2)

np.mod <-lm(NPmolar_cestode~ NPmolar_fish, data=stickstoich)
summary(np.mod)

#jpeg(file="Stickleback_CNP.jpeg", width = 270, height = 180, units = 'mm', res = 300)
ggarrange(Carbon, Nitrogen, Phosphorus, 
          CN, CP, NP, ncol=3, nrow=2)
#dev.off()
```
Boxplot graphics for infection status and stoich

```{r infection related to host stoichiometry}
C.infect<-stickstoich %>% drop_na(tapeworm_presence)%>%
  ggplot()+geom_boxplot(aes(x= tapeworm_presence, y= percentC_fish )) +rita_theme +labs(y="%C fish", x = "")

N.infect<-stickstoich %>% drop_na(tapeworm_presence)%>%
  ggplot()+geom_boxplot(aes(x= tapeworm_presence, y= percentN_fish )) +rita_theme +labs(y="%N fish", x = "")

P.infect<-stickstoich %>% drop_na(tapeworm_presence)%>%
  ggplot()+geom_boxplot(aes(x= tapeworm_presence, y= percentP_fish )) +rita_theme +labs(y="%P fish", x = "")

CN.infect<-stickstoich %>% drop_na(tapeworm_presence)%>%
  ggplot()+geom_boxplot(aes(x= tapeworm_presence, y= CNmolar_fish )) +rita_theme +labs(y="C:N fish", x = "")

CP.infect<-stickstoich %>% drop_na(tapeworm_presence)%>%
  ggplot()+geom_boxplot(aes(x= tapeworm_presence, y= CPmolar_fish )) +rita_theme +labs(y="C:P fish", x = "")

NP.infect<-stickstoich %>% drop_na(tapeworm_presence)%>%
  ggplot()+geom_boxplot(aes(x= tapeworm_presence, y= NPmolar_fish )) +rita_theme +labs(y="N:P fish", x = "")

#jpeg(file="Stickleback_infection_stoich.jpeg", width = 270, height = 180, units = 'mm', res = 300)
ggarrange(C.infect, N.infect, P.infect,
          CN.infect, CP.infect, NP.infect, ncol=3, nrow=2)
#dev.off()
```
Now for infection intensity and stoich 
Graphic and then linear models for ratios 

```{r infection intensity and host stoichiometry}

stickstoich %>%
  ggplot() +
  geom_point(aes(x= tapeworm_intensity, y = CNmolar_fish),
             position=position_jitter(w = 0.10, h = 0),
             pch=21, size=2)+rita_theme+
  geom_smooth(aes(x= tapeworm_intensity, y = CNmolar_fish), method='lm', se=FALSE, col='black', lty=2)+
  labs(x="", y="C:N fish")

cn.infection <-lm(CNmolar_fish ~ tapeworm_intensity + log10(standard_length_mm), data= stickstoich)
summary(cn.infection)

library(effects)

#extract partial residuals for graphics 
cn.est<-Effect('tapeworm_intensity', partial.residuals=T, cn.infection)
plot(cn.est)

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(cn.est$x.all)
trans <- I
x <- data.frame(lower = cn.est$lower, upper = cn.est$upper, fit = cn.est$fit, tapeworm_intensity = cn.est$x$tapeworm_intensity)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$tapeworm_intensity)] + cn.est$residuals)

#below corrects for effects of host body size 
allCN <- ggplot(x, aes(x = tapeworm_intensity, y = fit)) +
  rita_theme+
  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
  labs(x="", y="C:N fish")
#################################
stickstoich %>%
  ggplot() +
  geom_point(aes(x= tapeworm_intensity, y = CPmolar_fish),
             position=position_jitter(w = 0.10, h = 0),
             pch=21, size=2)+rita_theme+
 # geom_smooth(aes(x= tapeworm_intensity, y = CPmolar_fish), method='lm', se=FALSE, col='black', lty=2)+
  labs(x="", y="C:P fish")

cp.infection <-lm(CPmolar_fish ~ tapeworm_intensity + log10(standard_length_mm), data= stickstoich)
summary(cp.infection)

#extract partial residuals for graphics 
cp.est<-Effect('tapeworm_intensity', partial.residuals=T, cp.infection)
plot(cp.est)

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(cp.est$x.all)
trans <- I
x <- data.frame(lower = cp.est$lower, upper = cp.est$upper, fit = cp.est$fit, tapeworm_intensity = cp.est$x$tapeworm_intensity)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x2.fit), x$tapeworm_intensity)] + cp.est$residuals)

allCP <- ggplot(x, aes(x = tapeworm_intensity, y = fit)) +
  rita_theme+
#  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
 # geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
  labs(x="", y="C:P fish")
#################################
stickstoich %>%
  ggplot() +
  geom_point(aes(x= tapeworm_intensity, y = NPmolar_fish), 
             position=position_jitter(w = 0.10, h = 0),
             pch=21, size=2)+rita_theme+
 # geom_smooth(aes(x= tapeworm_intensity, y = NPmolar_fish), method='lm', se=FALSE, col='black', lty=2)+
  labs(x="S. solidus infection intensity", y="N:P fish")

np.infection <-lm(NPmolar_fish ~ tapeworm_intensity + log10(standard_length_mm), data= stickstoich)
summary(np.infection)

#extract partial residuals for graphics 
np.est<-Effect('tapeworm_intensity', partial.residuals=T, np.infection)
plot(np.est)

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(np.est$x.all)
trans <- I
x <- data.frame(lower = np.est$lower, upper = np.est$upper, fit = np.est$fit, tapeworm_intensity = np.est$x$tapeworm_intensity)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x2.fit), x$tapeworm_intensity)] + np.est$residuals)

allNP <- ggplot(x, aes(x = tapeworm_intensity, y = fit)) +
  rita_theme+
 # geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
#  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
  labs(x="S. solidus infection intensity", y="N:P fish")

#jpeg(file="Stickleback_intensity_CNP.jpeg", width = 90, height = 250, units = 'mm', res = 300)
ggarrange(allCN, allCP, allNP, nrow=3, ncol=1)
#dev.off()


```
