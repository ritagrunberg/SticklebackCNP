---
title: "Stickleback CNP"
author: "Rita Grunberg"
date: "4/27/2021"
output: html_document
---

```{r setup,  results='hide', message=FALSE, warning=FALSE}
rm(list = ls())  # clear Rs brain 

library(tidyr)   # tidying data
library(dplyr)   # manipulating df
library(ggplot2) # graphing
library(ggpubr)  # nice package for figures
library(cowplot) # plot grid
library(faraway)
library(effects)

stickstoich <- read.csv("C:/Users/grunberg/Documents/GitHub/SticklebackCNP/Data/Stickleback_CNP.csv")

```

Add graphical theme I use for plotting

```{r formatting}
rita_theme <-  theme_classic(base_size = 15)+
  theme(legend.title = element_text(size=7, face="bold"),
        legend.text = element_text(size=6.5),
        legend.position=c(0.15,0.18),
        axis.line = element_line(colour = 'black', size = 0.75),
        axis.ticks = element_line(colour = "black", size = 0.75),
        axis.text.x = element_text(size=12,  colour = "black"), 
        axis.text.y = element_text(size=12,  colour = "black"), # bold
        axis.title.y = element_text(size=14, colour = "black")
  )

```

Some data cleaning. Looking for data that looks weird and checking some stuff

```{r data cleaning and summary information}

#remove fish not analyzed for CNP
stickstoich <- stickstoich %>% drop_na(percentN_fish) # NA in percent N means fish was not analyzed for CNP

#df now has 52 fish 
stickstoich %>% filter(tapeworm_intensity >0) %>% summarise(total_fish = n_distinct(ID))

#note remove host  for paired stoichiometry analysis (parasite too small to analyze, parasite ~ 0.1 mg wet mass, also had no CNP values)
stickstoich %>% filter(tapeworm_intensity >0) %>% filter(percentN_worm > 0)%>%
  summarise(total_fish = n_distinct(ID))

#sample size for uninfected fish 
stickstoich %>% filter(tapeworm_presence == 'no') %>% summarise(total_fish = n_distinct(ID))

# Look at data to look for suspicious points
plot(wet_weight_fish_mg ~ standard_length_mm, stickstoich)
hist(stickstoich$dry_weight_worm_mg, col = "grey70")
plot(dry_weight_worm_mg ~ wet_weight_worm_mg, data = stickstoich) #dry mass of worm is clearly off for one observation 

stickstoich <- stickstoich %>% mutate(total_biomass = dry_weight_fish_mg  + dry_weight_worm_mg, 
                                      prop_parasite = dry_weight_worm_mg/total_biomass,
                                      C_infectpheno = (percentC_fish*(dry_weight_fish_mg/total_biomass)) +
                                        (percentC_worm*(dry_weight_worm_mg/total_biomass)),
                                       N_infectpheno = (percentN_fish*(dry_weight_fish_mg/total_biomass)) +
                                        (percentN_worm*(dry_weight_worm_mg/total_biomass)),
                                       P_infectpheno = (percentP_fish*(dry_weight_fish_mg/total_biomass)) +
                                        (percentP_worm*(dry_weight_worm_mg/total_biomass)),
                                      tapeworm_presence=as.factor(tapeworm_presence)
                                      )

stickstoich %>%filter(tapeworm_intensity >0) %>%
  filter(!ID ==20.030) %>%
  filter(!ID==20.039)%>%
    summarise_at(c('prop_parasite'),
               funs(mean,max, sd, se=sd(.)/sqrt(n())))

#average C N and P for host 

```

```{r host parasite mass}
hp_mass_graph <-stickstoich %>% 
filter(tapeworm_intensity >0)%>%
  filter(!ID ==20.030) %>%
  filter(!ID==20.039) %>% 
  gather(tissue, mass, c(5,9))

#jpeg(file="FigureS1_StickStoich.jpeg", width = 150, height = 120, units = 'mm', res = 300)
hp_mass_graph %>% 
  ggplot(aes(x=as.factor(ID), y = mass, fill=tissue))+ 
  geom_bar(position="stack", stat="identity")+
  theme_bw()+
  scale_fill_manual(values=c('grey', 'black'),
                    guide=guide_legend(override.aes=list(shape=21)), 
                    labels = c("fish","parasite"))+
  labs(y="Dry mass (mg)",
       x="Host ID")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
#dev.off()

```


Infection phenotype of host: consider if host uninfected, host+ parasit tissue as a unit, or infected host (w/o parasite) differ in their elemental content.

Aka does parasite tissue matter? 

This generates figure 2 of the manuscript

```{r infection phenotype CNP}
infect.pheno <-stickstoich %>% 
  filter(!ID ==20.030)%>%
  filter(!ID ==20.011)

jitter <- position_jitter(width = 0.1, height = 0)

####################################
############ Carbon
####################################
infect.pheno %>% gather(tissue, C, c(13,25))%>% 
  group_by(tissue, tapeworm_presence)%>%
  summarise(mean_C = mean(C),
         sd_C = sd(C),
         se_C=sd(C)/sqrt(n()),
        lower.CL = mean_C - se_C,
         upper.CL = mean_C + se_C)

C.pheno <-infect.pheno %>% gather(tissue, C, c(13,25))%>% 
  group_by(tissue, tapeworm_presence)%>%
  mutate(mean_C = mean(C),
         sd_C = sd(C),
         se_C=sd(C)/sqrt(n()),
        lower.CL = mean_C - se_C,
         upper.CL = mean_C + se_C)%>%
  ungroup()%>% 
  drop_na(mean_C)%>%
  mutate(infect.tissue = paste(tapeworm_presence, 
                               tissue, sep = "_"))%>% # combine info for plotting purposes 
  ggplot(aes(x=infect.tissue, y = C))+
  geom_errorbar(aes(ymax = lower.CL, ymin = upper.CL), width = .2)+
  geom_point(aes(x=infect.tissue, y = C), pch=21, position = jitter, alpha=0.3)+
  geom_point(aes(x= infect.tissue,y = mean_C, color=infect.tissue), size=2)+
  scale_color_manual(values=c("#636363", "#000000", "#000000"))+
  guides(color=FALSE)+
  rita_theme+labs(x="", y="Stickleback %C")+
  scale_x_discrete(labels=c("no_percentC_fish" = "Host (uninfected)",
                            "yes _C_infectpheno" = "Host + parasite",
                            "yes _percentC_fish" = "Host (infected)"))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.0, hjust=0.0))


infect.pheno.2 <-stickstoich %>% 
  filter(tapeworm_intensity >0)%>%
  filter(!ID ==20.030)%>%
  filter(!ID ==20.011) 

wilcox.test(infect.pheno.2$percentC_fish, infect.pheno.2$C_infectpheno, paired=TRUE)


####################################
#### nitrogen ########################
####################################
infect.pheno %>% gather(tissue, N, c(11,26))%>%
  group_by(tissue, tapeworm_presence)%>%
  summarise(mean_N = mean(N),
         sd_N = sd(N),
         se_N=sd(N)/sqrt(n()),
        lower.CL = mean_N - se_N,
         upper.CL = mean_N + se_N)

N.pheno <-infect.pheno %>% gather(tissue, N, c(11,26))%>%
  group_by(tissue, tapeworm_presence)%>%
  mutate(mean_N = mean(N),
         sd_N = sd(N),
         se_N=sd(N)/sqrt(n()),
        lower.CL = mean_N - se_N,
         upper.CL = mean_N + se_N)%>%  
  ungroup()%>%
  drop_na(mean_N)%>%
  mutate(infect.tissue = paste(tapeworm_presence, tissue, sep = "_"))%>%
  ggplot(aes(x=infect.tissue, y = N))+
  geom_errorbar(aes(ymax = lower.CL, ymin = upper.CL), width = .2)+
  geom_point(aes(x=infect.tissue, y = N), pch=21, position = jitter, alpha=0.3)+
  geom_point(aes(x= infect.tissue,y = mean_N, color=infect.tissue), size=2)+
  rita_theme+labs(x="", y="Stickleback %N")+
  scale_color_manual(values=c("#636363", "#000000", "#000000"))+
  guides(color=FALSE)+
  scale_x_discrete(labels=c("no_percentN_fish" = "Host (uninfected)",
                            "yes _N_infectpheno" = "Host + parasite",
                            "yes _percentN_fish" = "Host (infected)"))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.0, hjust=0.0))

wilcox.test(infect.pheno.2$percentN_fish, infect.pheno.2$N_infectpheno, paired=TRUE)

####################################
##### phosphorus 
####################################
infect.pheno %>% 
  gather(tissue, P, c(15,27))%>%
  group_by(tissue, tapeworm_presence)%>%
  summarise(mean_P = mean(P),
         sd_P = sd(P),
         se_P=sd(P)/sqrt(n()),
        lower.CL = mean_P - se_P,
         upper.CL = mean_P + se_P)

P.pheno <-infect.pheno %>% 
  gather(tissue, P, c(15,27))%>%
  group_by(tissue, tapeworm_presence)%>%
  mutate(mean_P = mean(P),
         sd_P = sd(P),
         se_P=sd(P)/sqrt(n()),
        lower.CL = mean_P - se_P,
         upper.CL = mean_P + se_P)%>% 
  ungroup()%>%
  drop_na(mean_P)%>%
  mutate(infect.tissue = paste(tapeworm_presence, tissue, sep = "_"))%>%
  ggplot(aes(x=infect.tissue, y = P))+
  geom_errorbar(aes(ymax = lower.CL, ymin = upper.CL), width = .2)+
  geom_point(aes(x=infect.tissue, y = P), pch=21, position = jitter, alpha=0.3)+
  geom_point(aes(x= infect.tissue,y = mean_P,  color=infect.tissue), size=2)+
  rita_theme+labs(x="", y="Stickleback %P")+
  scale_color_manual(values=c("#636363", "#000000", "#000000"))+
  guides(color=FALSE)+
  scale_x_discrete(labels=c("no_percentP_fish" = "Host (uninfected)",
                            "yes _P_infectpheno" = "Host + parasite",
                            "yes _percentP_fish" = "Host (infected)"))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.0, hjust=0.0))

wilcox.test(infect.pheno.2$percentP_fish, infect.pheno.2$P_infectpheno, paired=TRUE)

#jpeg(file="Fig2.jpeg", width = 174, height = 120, units = 'mm', res = 300)
ggarrange(C.pheno, N.pheno, P.pheno, nrow = 1)
#dev.off()
```

First paired t-test to asses whether stickleback and S. solidus elemental composition differ for infected individuals only


```{r check normality}
stick_infected <- stickstoich %>% filter(tapeworm_intensity >0)%>%
  filter(!ID ==20.030)%>%
  filter(!ID ==20.011) #fish lacks paired CNP parasite data; 030 no CNP done on worm, and 011 worm sample mass too small to get reliable measure 

par(mfrow=c(1,2)) 
hist(stick_infected$percentC_worm, col='steelblue', main='Normal')
qqnorm(stick_infected$percentC_worm, main='Normal')
qqline(stick_infected$percentC_worm)

library(car)
#logit transformaiton of % values 
stick_infected <- stickstoich %>% filter(tapeworm_intensity >0)%>%
  filter(!ID ==20.030)%>%
  filter(!ID ==20.011)%>%
  mutate(logitCworm = logit(percentC_worm/100),
         logitNworm = logit(percentN_worm/100),
         logitPworm = logit(percentP_worm/100),
         logitCfish = logit(percentC_fish/100),
         logitNfish = logit(percentN_fish/100),
         logitPfish = logit(percentP_fish/100)
         )

```

```{r host parasite stoichiometry t-test}
stick_infected <- stickstoich %>% 
  filter(tapeworm_intensity >0)%>%
  filter(!ID ==20.030)%>%
  filter(!ID ==20.011) #fish lacks paired CNP parasite data; 030 no CNP done on worm, and 011 worm sample mass too small to get reliable measure 

wilcox.test(stick_infected$percentC_worm,stick_infected$percentC_fish, paired=TRUE)
wilcox.test(stick_infected$percentN_worm, stick_infected$percentN_fish, paired=TRUE)
wilcox.test(stick_infected$percentP_worm,stick_infected$percentP_fish, paired=TRUE)

stick_meanC <- stick_infected %>% filter(tapeworm_presence == 'yes') %>%
  summarise_at(c('percentC_fish', 'percentC_worm'),
               funs(mean, sd, se=sd(.)/sqrt(n()))
               )%>% mutate(Element = "C")

stick_meanN <- stick_infected%>% filter(tapeworm_presence == 'yes') %>%
  summarise_at(c( 'percentN_fish', 'percentN_worm'),        
               funs(mean, sd, se=sd(.)/sqrt(n()))
               )%>% mutate(Element = "N")

stick_meanP <- stick_infected %>% filter(tapeworm_presence == 'yes') %>%
  summarise_at(c('percentP_fish', 'percentP_worm'), 
               funs(mean, sd, se=sd(.)/sqrt(n()))
               )%>% mutate(Element = "P")
# next look at ratios 
wilcox.test(log10(stick_infected$CNmolar_cestode), log10(stick_infected$CNmolar_fish), paired=TRUE)
wilcox.test(log10(stick_infected$CPmolar_cestode), log10(stick_infected$CPmolar_fish), paired=TRUE)
wilcox.test(log10(stick_infected$NPmolar_cestode),log10(stick_infected$NPmolar_fish), paired=TRUE)


```

Correlation tests between host and parasite stoichiometry 

```{r host parasite stoichiometry correlation}

##################
#elemental content
##################
# cor.test(stick_infected$percentC_worm,stick_infected$percentC_fish)
# cor.test(stick_infected$percentN_worm, stick_infected$percentN_fish)
# cor.test(stick_infected$percentP_worm,stick_infected$percentP_fish)

#logit transformed data
cor.test(stick_infected$logitCworm,stick_infected$logitCfish)
cor.test(stick_infected$logitNworm, stick_infected$logitNfish)
cor.test(stick_infected$logitPworm,stick_infected$logitPfish)

##################
#ratios
##################
# cor.test(stick_infected$CNmolar_fish,stick_infected$CNmolar_cestode)
# cor.test(stick_infected$CPmolar_fish, stick_infected$CPmolar_cestode)
# cor.test(stick_infected$NPmolar_fish,stick_infected$NPmolar_cestode)

#log transformed ratios
cor.test(log10(stick_infected$CNmolar_fish),log10(stick_infected$CNmolar_cestode))
cor.test(log10(stick_infected$CPmolar_fish), log10(stick_infected$CPmolar_cestode))
cor.test(log10(stick_infected$NPmolar_fish),log10(stick_infected$NPmolar_cestode))
```

Graphics to display correlations or lack there of 

Generates Figure 1

```{r stick and parasite C correlation}
library(patchwork)
library(ggExtra)

Carbon <-stickstoich%>% filter(tapeworm_intensity >0)%>%ggplot()+
  geom_point(aes(x=percentC_fish, y = percentC_worm), pch=21, size=2)+rita_theme+ 
  labs(x= "Stickleback %C",y=expression(paste(italic("S. solidus"), " %C")))+
  xlim(c(22,60))+   ylim(c(22,60)) +
 # geom_smooth(aes(x=percentC_fish, y = percentC_worm),method='lm',se=FALSE, col='#525252')+
  geom_abline(intercept = 0, slope = 1, lty=2)

Carbon.marg <-ggMarginal(Carbon, fill='grey', alpha=0.3)
carbon.mod <-lm(percentC_worm~ percentC_fish, data=stickstoich)
summary(carbon.mod)
Carbon
```

```{r stickle and parasite other correlations}
Nitrogen <-stickstoich%>% ggplot()+
  geom_point(aes(x=percentN_fish, y = percentN_worm), pch=21, size=2)+rita_theme+ 
  labs(x= "Stickleback %N ",y=expression(paste(italic("S. solidus"), " %N")))+
  xlim(c(5,14))+   ylim(c(5,14)) +
  #  geom_smooth(aes(x=percentN_fish, y = percentN_worm),method='lm',se=FALSE, col='#525252')+
   geom_abline(intercept = 0, slope = 1, lty=2)

nitrogen.mod <-lm(percentN_worm~ percentN_fish, data=stickstoich)
summary(nitrogen.mod)

Nitrogen.marg <-ggMarginal(Nitrogen, fill='grey', alpha=0.3)

####################
Phosphorus <-stickstoich%>% ggplot()+
  geom_point(aes(x=percentP_fish, y = percentP_worm), pch=21, size=2)+rita_theme+ 
  labs(x= "Stickleback %P ",y=expression(paste(italic("S. solidus"), " %P")))+
   xlim(c(1,7))+   ylim(c(1,7)) +
  #  geom_smooth(aes(x=percentP_fish, y = percentP_worm),method='lm',se=FALSE, col='#525252')+
   geom_abline(intercept = 0, slope = 1, lty=2)

phosph.mod <-lm(percentP_worm~ percentP_fish, data=stickstoich)
summary(phosph.mod)

Phosphorus.marg <-ggMarginal(Phosphorus, fill='grey', alpha=0.3)


####################
CN <-stickstoich%>% ggplot()+
  geom_point(aes(x=CNmolar_fish, y = CNmolar_cestode), pch=21, size=2)+rita_theme+ 
  labs(x= "Stickleback C:N ", y=expression(paste(italic("S. solidus"), " C:N")))+
  xlim(c(1,3.5))+   ylim(c(1,3.5)) +
   # geom_smooth(aes(x=CNmolar_fish, y = CNmolar_cestode),method='lm',se=FALSE, col='#525252')+
   geom_abline(intercept = 0, slope = 1, lty=2)

cn.mod <-lm(CNmolar_cestode~ CNmolar_fish, data=stickstoich)
summary(cn.mod)

CN.marg <-ggMarginal(CN, fill='grey', alpha=0.3)


####################
CP <-stickstoich%>% ggplot()+
  geom_point(aes(x=CPmolar_fish, y = CPmolar_cestode), pch=21, size=2)+rita_theme+ 
  labs(x= "Stickleback C:P ", y=expression(paste(italic("S. solidus"), " C:P")))+
  xlim(c(6,40))+   ylim(c(6,40)) +
  #  geom_smooth(aes(x=CPmolar_fish, y = CPmolar_cestode),method='lm',se=FALSE, col='#525252')+
   geom_abline(intercept = 0, slope = 1, lty=2)

cp.mod <-lm(CPmolar_cestode~ CPmolar_fish, data=stickstoich)
summary(cp.mod)

CP.marg <-ggMarginal(CP, fill='grey', alpha=0.3)

####################
NP <-stickstoich%>% ggplot()+
  geom_point(aes(x=NPmolar_fish, y = NPmolar_cestode), pch=21, size=2)+rita_theme+
  labs(x= "Stickleback N:P ", y=expression(paste(italic("S. solidus"), " N:P")))+
   xlim(c(2,25))+   ylim(c(2,25)) +
  #  geom_smooth(aes(x=NPmolar_fish, y = NPmolar_cestode),method='lm',se=FALSE, col='#525252')+
   geom_abline(intercept = 0, slope = 1, lty=2)

np.mod <-lm(NPmolar_cestode~ NPmolar_fish, data=stickstoich)
summary(np.mod)

NP.marg <-ggMarginal(NP, fill='grey', alpha=0.3)

# #jpeg(file="Figure1_StickStoich_defunct.jpeg", width = 270, height = 180, units = 'mm', res = 300)
# ggarrange(Carbon, Nitrogen, Phosphorus, 
#           CN, CP, NP, labels='auto',
#           ncol=3, nrow=2)
# dev.off()

#jpeg(file="Fig1.jpeg", width = 234, height = 174, units = 'mm', res = 400)
ggarrange(Carbon.marg, Nitrogen.marg, Phosphorus.marg, 
          CN.marg, CP.marg, NP.marg, labels='auto',
          ncol=3, nrow=2)
#dev.off()
```
Boxplot graphics for infection status and stoich

```{r infection related to host stoichiometry}

jitter <- position_jitter(width = 0.1, height = 0)

C.infect<-stickstoich %>% drop_na(tapeworm_presence)%>%
  group_by(tapeworm_presence)%>%
  mutate(mean_C = mean(percentC_fish),
         sd_C = sd(percentC_fish),
         se_C=sd(percentC_fish)/sqrt(n()),
         lower.CL = mean_C - se_C,
         upper.CL = mean_C + se_C)%>% ungroup()%>%
  ggplot(aes(x=tapeworm_presence, y = mean_C))+
  geom_errorbar(aes(ymax = lower.CL, ymin = upper.CL), width = .2)+
  geom_point(aes(x= tapeworm_presence, y= percentC_fish),position = jitter, pch=21, alpha=0.3) +
  geom_point(aes(x=tapeworm_presence, y = mean_C), size=3)+
  rita_theme +
    labs(y="%C stickleback", x = "")+
    scale_x_discrete(labels=c("no" = "uninfected", "yes" = "infected"))

N.infect<-stickstoich %>% drop_na(tapeworm_presence)%>%
  group_by(tapeworm_presence)%>%
  mutate(mean_N = mean(percentN_fish),
         sd_N = sd(percentN_fish),
         se_N=sd(percentN_fish)/sqrt(n()),
         lower.CL = mean_N - se_N,
         upper.CL = mean_N + se_N)%>% ungroup()%>%
  ggplot(aes(x=tapeworm_presence, y = mean_N))+
  geom_errorbar(aes(ymax = lower.CL, ymin = upper.CL), width = .2)+
  geom_point(aes(x= tapeworm_presence, y= percentN_fish ),position = jitter, pch=21, alpha=0.3) +rita_theme +
    geom_point(aes(x=tapeworm_presence, y = mean_N), size=3)+
  labs(y="%N stickleback", x = "")+
  scale_x_discrete(labels=c("no" = "uninfected", "yes" = "infected"))

P.infect<-stickstoich %>% drop_na(tapeworm_presence)%>%
  group_by(tapeworm_presence)%>%
  mutate(mean_P = mean(percentP_fish),
         sd_P = sd(percentP_fish),
         se_P=sd(percentP_fish)/sqrt(n()),
         lower.CL = mean_P - se_P,
         upper.CL = mean_P + se_P)%>% ungroup()%>%
  ggplot(aes(x=tapeworm_presence, y = mean_P))+
    geom_errorbar(aes(ymax = lower.CL, ymin = upper.CL), width = .2)+
  geom_point(aes(x= tapeworm_presence, y= percentP_fish),position = jitter, pch=21, alpha=0.3) +rita_theme +
      geom_point(aes(x=tapeworm_presence, y = mean_P), size=3)+
  labs(y="%P stickleback", x = "")+
  scale_x_discrete(labels=c("no" = "uninfected", "yes" = "infected"))

CN.infect<-stickstoich %>% drop_na(tapeworm_presence)%>%
  group_by(tapeworm_presence)%>%
  mutate(mean_CN = mean(CNmolar_fish),
         sd_CN = sd(CNmolar_fish),
         se_CN=sd(CNmolar_fish)/sqrt(n()),
          lower.CL = mean_CN - se_CN,
         upper.CL = mean_CN + se_CN)%>% ungroup()%>%
  ggplot(aes(x=tapeworm_presence, y = mean_CN))+
  geom_errorbar(aes(ymax = lower.CL, ymin = upper.CL), width = .2)+
  geom_point(aes(x= tapeworm_presence, y= CNmolar_fish),position = jitter, pch=21, alpha=0.3) +rita_theme +
  geom_point(aes(x=tapeworm_presence, y = mean_CN), size=3)+
  labs(y="C:N stickleback", x = "")+
    annotate('text', x = 1.5, y = 1.6, label='"*"', parse=TRUE, size=10)+
  scale_x_discrete(labels=c("no" = "uninfected", "yes" = "infected"))

CP.infect<-stickstoich %>% drop_na(tapeworm_presence)%>%
  group_by(tapeworm_presence)%>%
  mutate(mean_CP = mean(CPmolar_fish),
         sd_CP = sd(CPmolar_fish),
         se_CP=sd(CPmolar_fish)/sqrt(n()),
        lower.CL = mean_CP - se_CP,
         upper.CL = mean_CP + se_CP)%>% ungroup()%>%
  ggplot(aes(x=tapeworm_presence, y = mean_CP))+
    geom_errorbar(aes(ymax = lower.CL, ymin = upper.CL), width = .2)+
  geom_point(aes(x= tapeworm_presence, y= CPmolar_fish),position = jitter, pch=21, alpha=0.3) +rita_theme +
    geom_point(aes(x=tapeworm_presence, y = mean_CP), size=3)+
  labs(y="C:P stickleback", x = "")+
  scale_x_discrete(labels=c("no" = "uninfected", "yes" = "infected"))

NP.infect<-stickstoich %>% drop_na(tapeworm_presence)%>%
  group_by(tapeworm_presence)%>%
  mutate(mean_NP = mean(NPmolar_fish),
         sd_NP = sd(NPmolar_fish),
         se_NP=sd(NPmolar_fish)/sqrt(n()),
        lower.CL = mean_NP - se_NP,
         upper.CL = mean_NP + se_NP)%>% ungroup()%>%
  ggplot(aes(x=tapeworm_presence, y = mean_NP))+
  geom_errorbar(aes(ymax = lower.CL, ymin = upper.CL), width = .2)+
  geom_point(aes(x= tapeworm_presence, y= NPmolar_fish),position = jitter, pch=21, alpha=0.3) +rita_theme +
      geom_point(aes(x=tapeworm_presence, y = mean_NP), size=3)+
  labs(y="N:P stickleback", x = "")+
  scale_x_discrete(labels=c("no" = "uninfected", "yes" = "infected"))

#jpeg(file="FigureS2_StickStoich.jpeg", width = 270, height = 180, units = 'mm', res = 300)
ggarrange(C.infect, N.infect, P.infect,
          CN.infect, CP.infect, NP.infect, ncol=3, nrow=2)
#dev.off()
```

Is host elemental composition related to parasite infection status after correcting for effects of host body mass?

```{r modesl for infection and stoich}
stickstoich <- stickstoich %>% 
  filter(!ID ==20.030)%>%
  filter(!ID ==20.011)%>%
  mutate(logitCworm = logit(percentC_worm/100),
         logitNworm = logit(percentN_worm/100),
         logitPworm = logit(percentP_worm/100),
         logitCfish = logit(percentC_fish/100),
         logitNfish = logit(percentN_fish/100),
         logitPfish = logit(percentP_fish/100),
         logCNfish = log10(CNmolar_fish),
         logCPfish = log10(CPmolar_fish),
         logNPfish =log10(NPmolar_fish),
         logCNworm = log10(CNmolar_cestode),
         logCPworm = log10(CPmolar_cestode),
         logNPworm =log10(NPmolar_cestode)
         )

c.infection <-lm(logitCfish ~ tapeworm_presence + log10(dry_weight_fish_mg), data= stickstoich)
c.infection <-lm(logitCfish ~ tapeworm_presence * log10(dry_weight_fish_mg), data= stickstoich)

summary(c.infection)

n.infection <-lm(logitNfish ~ tapeworm_presence + log10(dry_weight_fish_mg), data= stickstoich)
n.infection <-lm(logitNfish ~ tapeworm_presence * log10(dry_weight_fish_mg), data= stickstoich)

summary(n.infection)

p.infection <-lm(logitPfish ~ tapeworm_presence + log10(dry_weight_fish_mg), data= stickstoich)
p.infection <-lm(logitPfish ~ tapeworm_presence * log10(dry_weight_fish_mg), data= stickstoich)
summary(p.infection)


cn.infection <-lm(logCNfish ~ tapeworm_presence + log10(dry_weight_fish_mg), data= stickstoich)
cn.infection <-lm(logCNfish ~ tapeworm_presence * log10(dry_weight_fish_mg), data= stickstoich)

summary(cn.infection)

cp.infection <-lm(logCPfish ~ tapeworm_presence + log10(dry_weight_fish_mg), data= stickstoich)
cp.infection <-lm(logCPfish ~ tapeworm_presence * log10(dry_weight_fish_mg), data= stickstoich)

summary(cp.infection)

np.infection <-lm(logNPfish ~ tapeworm_presence + log10(dry_weight_fish_mg), data= stickstoich)
np.infection <-lm(logNPfish ~ tapeworm_presence + log10(dry_weight_fish_mg), data= stickstoich)

summary(np.infection)


```


Now for infection intensity and stoich 
Graphic and then linear models for ratios 

Generates Figure 3

```{r infection intensity and host stoichiometry}



stickstoich <- stickstoich %>% mutate(log_intensity = log10(tapeworm_intensity+1))

c.infection2 <-lm(logitCfish ~ log_intensity + log10(dry_weight_fish_mg), data= stickstoich)
c.infection2 <-lm(logitCfish ~ log_intensity * log10(dry_weight_fish_mg), data= stickstoich)

summary(c.infection2)

n.infection2 <-lm(logitNfish ~ log_intensity + log10(dry_weight_fish_mg), data= stickstoich)
n.infection2 <-lm(logitNfish ~ log_intensity * log10(dry_weight_fish_mg), data= stickstoich)

summary(n.infection2)

p.infection2 <-lm(logitPfish ~ log_intensity + log10(dry_weight_fish_mg), data= stickstoich)
p.infection2 <-lm(logitPfish ~ log_intensity * log10(dry_weight_fish_mg), data= stickstoich)

summary(p.infection2)

stickstoich %>%
  ggplot() +
  geom_point(aes(x= tapeworm_intensity, y = logCNfish),
             position=position_jitter(w = 0.10, h = 0),
             pch=21, size=2)+rita_theme+
  geom_smooth(aes(x= log_intensity, y = logCNfish), method='lm', se=FALSE, col='black', lty=2)+
  labs(x="", y="C:N fish")

cn.infection <-lm(logCNfish ~ log_intensity + log10(dry_weight_fish_mg), data= stickstoich)
cn.infection <-lm(logCNfish ~ log_intensity * log10(dry_weight_fish_mg), data= stickstoich)

summary(cn.infection)

library(effects)

#extract partial residuals for graphics 
cn.est<-Effect('log_intensity', partial.residuals=T, cn.infection)
plot(cn.est)

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(cn.est$x.all)
trans <- I
x <- data.frame(lower = cn.est$lower, 
                upper = cn.est$upper, 
                fit = cn.est$fit, 
                log_intensity = cn.est$x$log_intensity)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$log_intensity)] + cn.est$residuals)

#below corrects for effects of host body size 
allCN <- ggplot(x, aes(x = log_intensity, y = fit)) +
  rita_theme+
  geom_line(size = 1, lty=2) +
 geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
    labs(y=expression(log["10"]~Stickleback~C:N),
         x="")
#################################
stickstoich %>%
  ggplot() +
  geom_point(aes(x= log_intensity, y = CPmolar_fish),
             position=position_jitter(w = 0.10, h = 0),
             pch=21, size=2)+rita_theme+
 # geom_smooth(aes(x= log_intensity, y = CPmolar_fish), method='lm', se=FALSE, col='black', lty=2)+
  labs(x="", y="C:P fish")

cp.infection <-lm(logCPfish ~ log_intensity+ log10(dry_weight_fish_mg), data= stickstoich)
summary(cp.infection)

#extract partial residuals for graphics 
cp.est<-Effect('log_intensity', partial.residuals=T, cp.infection)
plot(cp.est)

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(cp.est$x.all)
trans <- I
x <- data.frame(lower = cp.est$lower, upper = cp.est$upper,
                fit = cp.est$fit, log_intensity = cp.est$x$log_intensity)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$log_intensity)] + cp.est$residuals)

allCP <- ggplot(x, aes(x = log_intensity, y = fit)) +
  rita_theme+
#  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
 # geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
    labs(y=expression(log["10"]~Stickleback~C:P),
         x="")
#################################
stickstoich %>%
  ggplot() +
  geom_point(aes(x= log_intensity, y = NPmolar_fish), 
             position=position_jitter(w = 0.10, h = 0),
             pch=21, size=2)+rita_theme+
 # geom_smooth(aes(x= log_intensity, y = NPmolar_fish), method='lm', se=FALSE, col='black', lty=2)+
  labs(x="S. solidus infection intensity", y="N:P fish")

np.infection <-lm(logNPfish ~ log_intensity + log10(dry_weight_fish_mg), data= stickstoich)
summary(np.infection)

#extract partial residuals for graphics 
np.est<-Effect('log_intensity', partial.residuals=T, np.infection)
plot(np.est)

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(np.est$x.all)
trans <- I
x <- data.frame(lower = np.est$lower, upper = np.est$upper, fit = np.est$fit, log_intensity = np.est$x$log_intensity)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$log_intensity)] + np.est$residuals)

allNP <- ggplot(x, aes(x = log_intensity, y = fit)) +
  rita_theme+
 # geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
#  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
    labs(y=expression(log["10"]~Stickleback~N:P),
         x=expression(log["10"]~paste(italic("S. solidus"), " intensity"))
         ) 

#jpeg(file="Fig3.jpeg", width = 84, height = 234, units = 'mm', res = 400)
ggarrange(allCN, allCP, allNP, labels='auto',nrow=3, ncol=1)
#dev.off()


```
Now to build models related to determints of parasite stoichiometry

Is parasite stoichiometry related to parasite body mass and within host density (n parasites/ gram of host tissue)? 

Generates Figure 4


```{r parasite carbon}
library(effects)
# filter by infected hosts first
# remove parasites that not analyzed for CNP and had incorrect mass put in
parasite <-stickstoich %>% filter(tapeworm_intensity>0) %>%
  filter(!ID ==20.030) %>% # no CNP analysis done for this worm 
  filter(!ID==20.039) %>% # sample mass appears to be wrong; can't use mass measurements of worm
  filter(!ID ==20.011) %>% # sample mass of worm is too small to get a reliable CNP value based on past experience
  mutate(parasite_density = log10(tapeworm_intensity/dry_weight_fish_mg),
         log_parasite_mass = log10(dry_weight_worm_mg))

#are body size and density related
cor.test(parasite$parasite_density, parasite$log_parasite_mass)
#jpeg(file="SFigure_densitymass.jpeg", width = 110, height = 110, units = 'mm', res = 300)
parasite%>% ggplot(aes(x=log_parasite_mass, y = parasite_density))+ 
  geom_point(pch=21, size=2)+
  rita_theme +
  labs(x='log parasite body mass', y = "log parasite density")
#dev.off()
##################### models
# carbon
# C.parasite <- lm(percentC_worm ~ log_parasite_mass + parasite_density#
#                  ,data= parasite)
# summary(C.parasite)

C.parasite <- lm(logitCworm ~ log_parasite_mass + parasite_density#
                 ,data= parasite)
summary(C.parasite)
library(car)

#abline(v = 5, lwd = 3, lty = 2)    #add vertical line at 5 as after 5 there is severe correlation
C.est<-Effect('parasite_density', partial.residuals=T, C.parasite)
C.est2<-Effect('log_parasite_mass', partial.residuals=T, C.parasite)

plot(C.est)
plot(C.est2)

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(C.est$x.all)
trans <- I
x <- data.frame(lower = C.est$lower, upper = C.est$upper, fit = C.est$fit, parasite_density = C.est$x$parasite_density)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$parasite_density)] + C.est$residuals)


C_density <- ggplot(x, aes(x = parasite_density, y = fit)) +
  rita_theme+
#  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
#  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
   labs(x=expression(log["10"]~paste(italic("S. solidus"), " density")),
         y=expression(paste("logit ",italic("S. solidus"), " %C"))
         ) +
  xlim(c(-2.8,-0.9))
C_density

C.est2<-Effect('log_parasite_mass', partial.residuals=T, C.parasite)
closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(C.est2$x.all)
trans <- I
x <- data.frame(lower = C.est2$lower, upper = C.est2$upper, fit = C.est2$fit, log_parasite_mass = C.est2$x$log_parasite_mass)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$log_parasite_mass)] + C.est2$residuals)

C_mass <- ggplot(x, aes(x = log_parasite_mass, y = fit)) +
  rita_theme+
  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
   labs(x=expression(log["10"]~paste(italic("S. solidus"), " body mass")),
         y=expression(paste("logit ",italic("S. solidus"), " %C"))
         ) 

```

```{r parasite Nitrogen}

#####################
# nitrogen
# N.parasite <- lm(percentN_worm ~ log_parasite_mass + parasite_density
#                  , data= parasite)
# summary(N.parasite)

N.parasite <- lm(logitNworm ~ log_parasite_mass + parasite_density
                 , data= parasite)
summary(N.parasite)

vif(N.parasite)

N.est<-Effect('parasite_density', partial.residuals=T, N.parasite)
N.est2<-Effect('log_parasite_mass', partial.residuals=T, N.parasite)

plot(N.est)
plot(N.est2)

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(N.est$x.all)
trans <- I
x <- data.frame(lower = N.est$lower, upper = N.est$upper, fit = N.est$fit, parasite_density = N.est$x$parasite_density)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$parasite_density)] + N.est$residuals)

N_density <- ggplot(x, aes(x = parasite_density, y = fit)) +
  rita_theme+
  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
     labs(x=expression(log["10"]~paste(italic("S. solidus"), " density")),
         y=expression(paste("logit ",italic("S. solidus"), " %N"))
         )   + 
  xlim(c(-2.8,-0.9))


closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(N.est2$x.all)
trans <- I
x <- data.frame(lower = N.est2$lower, upper = N.est2$upper, fit = N.est2$fit, log_parasite_mass = N.est2$x$log_parasite_mass)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$log_parasite_mass)] + N.est2$residuals)

N_mass <- ggplot(x, aes(x = log_parasite_mass, y = fit)) +
  rita_theme+
  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
     labs(x=expression(log["10"]~paste(italic("S. solidus"), " body mass")),
         y=expression(paste("logit ",italic("S. solidus"), " %N"))
         ) 

```

```{r parasite Phosphorus}
#####################
#phosphorus 
# P.parasite <- lm((percentP_worm) ~ log_parasite_mass + parasite_density
#                  , data= parasite)
# summary(P.parasite)

P.parasite <- lm(logitPworm ~ log_parasite_mass + parasite_density
                 , data= parasite)
summary(P.parasite)

vif(P.parasite)

P.est<-Effect('parasite_density', partial.residuals=T, P.parasite)
P.est2<-Effect('log_parasite_mass', partial.residuals=T, P.parasite)

plot(P.est)
plot(P.est2)

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(P.est$x.all)
trans <- I
x <- data.frame(lower = P.est$lower, upper = P.est$upper, fit = P.est$fit, parasite_density = P.est$x$parasite_density)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$parasite_density)] + P.est$residuals)

P_density <- ggplot(x, aes(x = parasite_density, y = fit)) +
  rita_theme+
  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
   labs(x=expression(log["10"]~paste(italic("S. solidus"), " density")),
         y=expression(paste("logit ",italic("S. solidus"), " %P"))
         )  + 
  xlim(c(-2.8,-0.9))



closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(P.est2$x.all)
trans <- I
x <- data.frame(lower = P.est2$lower, upper = P.est2$upper, fit = P.est2$fit, log_parasite_mass = P.est2$x$log_parasite_mass)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$log_parasite_mass)] + P.est2$residuals)

P_mass <- ggplot(x, aes(x = log_parasite_mass, y = fit)) +
  rita_theme+
  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
   labs(x=expression(log["10"]~paste(italic("S. solidus"), " body mass")),
         y=expression(paste("logit ",italic("S. solidus"), " %P"))
         ) 
```

```{r paneled figure}

#jpeg(file="Fig4.jpeg", width = 174, height = 234, units = 'mm', res = 400)
ggarrange(C_mass, C_density,
          N_mass, N_density,
          P_mass, P_density, ncol=2, nrow=3, labels='auto')
#dev.off()
```

Now for elemental ratios
```{r parasite C:N}
##################### models
# c:n
# CN.parasite <- lm(CNmolar_cestode ~ log_parasite_mass + parasite_density#
#                  ,data= parasite)
# summary(CN.parasite)

CN.parasite <- lm(logCNworm ~ log_parasite_mass + parasite_density#
                 ,data= parasite)
summary(CN.parasite)

CN.est<-Effect('parasite_density', partial.residuals=T, CN.parasite)
CN.est2<-Effect('log_parasite_mass', partial.residuals=T, CN.parasite)

plot(CN.est)
plot(CN.est2)

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(CN.est$x.all)
trans <- I
x <- data.frame(lower = CN.est$lower, upper = CN.est$upper, fit = CN.est$fit, parasite_density = CN.est$x$parasite_density)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$parasite_density)] + CN.est$residuals)

CN_density <- ggplot(x, aes(x = parasite_density, y = fit)) +
  rita_theme+
  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
   labs(x=expression(log["10"]~paste("S. ",italic("solidus"), " density")),
         y=expression(log["10"]~paste("S. ",italic("solidus"), " C:N"))
         ) 


closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(CN.est2$x.all)
trans <- I
x <- data.frame(lower = CN.est2$lower, upper = CN.est2$upper, fit = CN.est2$fit, log_parasite_mass = CN.est2$x$log_parasite_mass)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$log_parasite_mass)] + CN.est2$residuals)

CN_mass <- ggplot(x, aes(x = log_parasite_mass, y = fit)) +
  rita_theme+
 # geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
  #geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
     labs(x=expression(log["10"]~paste(italic("S. solidus"), " body mass")),
         y=expression(log["10"]~paste(italic("S. solidus"), " C:N"))
         ) 

```

```{r parasite CP}

###############
# C:P
#CP.parasite <- lm(CPmolar_cestode ~ log_parasite_mass + parasite_density
 #                , data= parasite)

CP.parasite <- lm(logCPworm ~ log_parasite_mass + parasite_density
                 , data= parasite)
summary(CP.parasite)
CP.est<-Effect('parasite_density', partial.residuals=T, CP.parasite)
CP.est2<-Effect('log_parasite_mass', partial.residuals=T, CP.parasite)

plot(CP.est)
plot(CP.est2)

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(CP.est$x.all)
trans <- I
x <- data.frame(lower = CP.est$lower, upper = CP.est$upper, fit = CP.est$fit, parasite_density = CP.est$x$parasite_density)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$parasite_density)] + CP.est$residuals)

CP_density <- ggplot(x, aes(x = parasite_density, y = fit)) +
  rita_theme+
  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
   labs(x=expression(log["10"]~paste(italic("S. solidus"), " density")),
         y=expression(log["10"]~paste(italic("S. solidus"), " C:P"))
         ) 

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(CP.est2$x.all)
trans <- I
x <- data.frame(lower = CP.est2$lower, upper = CP.est2$upper, fit = CP.est2$fit, log_parasite_mass = CP.est2$x$log_parasite_mass)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$log_parasite_mass)] + CP.est2$residuals)

CP_mass <- ggplot(x, aes(x = log_parasite_mass, y = fit)) +
  rita_theme+
  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
   labs(x=expression(log["10"]~paste(italic("S. solidus"), " body mass")),
         y=expression(log["10"]~paste(italic("S. solidus"), " C:P"))
         ) 
```

```{r parasite N:P}
###############
#N:P
#NP.parasite <- lm(NPmolar_cestode ~ log_parasite_mass + parasite_density
 #                , data= parasite)

NP.parasite <- lm(logNPworm ~ log_parasite_mass + parasite_density
                 , data= parasite)

summary(NP.parasite)
NP.est<-Effect('parasite_density', partial.residuals=T, NP.parasite)
NP.est2<-Effect('log_parasite_mass', partial.residuals=T, NP.parasite)

plot(NP.est)
plot(NP.est2)

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(NP.est$x.all)
trans <- I
x <- data.frame(lower = NP.est$lower, upper = NP.est$upper, fit = NP.est$fit, parasite_density = NP.est$x$parasite_density)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$parasite_density)] + NP.est$residuals)

NP_density <- ggplot(x, aes(x = parasite_density, y = fit)) +
  rita_theme+
#  geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
 # geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
   labs(x=expression(log["10"]~paste(italic("S. solidus"), " density")),
         y=expression(log["10"]~paste(italic("S. solidus"), " N:P"))
         ) 

closest <- function(x, x0) apply(outer(x, x0, FUN=function(x, x0) abs(x - x0)), 1, which.min)
x.fit <- unlist(NP.est2$x.all)
trans <- I
x <- data.frame(lower = NP.est2$lower, upper = NP.est2$upper, fit = NP.est2$fit, log_parasite_mass = NP.est2$x$log_parasite_mass)
xy <- data.frame(x = x.fit, y = x$fit[closest(trans(x.fit), x$log_parasite_mass)] + NP.est2$residuals)

NP_mass <- ggplot(x, aes(x = log_parasite_mass, y = fit)) +
  rita_theme+
 # geom_line(size = 1, lty=2) +
  geom_point(data = xy, aes(x = x, y = y), shape = 1, col = "black", size = 2) +
#  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1)+
   labs(x=expression(log["10"]~paste("S. ",italic("solidus"), " body mass")),
         y=expression(log["10"]~paste("S. ",italic("solidus"), " N:P"))
         ) 
```

```{r elemental ratios supp figure}
#jpeg(file="FigureS3_StickStoich.jpeg", width = 180, height = 250, units = 'mm', res = 300)
ggarrange(CN_mass, CN_density,
          CP_mass, CP_density,
          NP_mass, NP_density, ncol=2, nrow=3, labels = 'auto')
#dev.off()
```